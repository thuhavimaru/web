<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NAGUMO - Điều khiển bể cá</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {font-family: Arial; background:white; color:black; padding:20px; margin:0;}
    h1 {text-align:center; color:#0066cc; border-bottom:2px solid #0066cc; padding-bottom:10px;}
    .status {font-size:24px; text-align:center; margin:20px; padding:15px; background:#f0f0f0;}
    .btn {display:block; width:80%; margin:15px auto; padding:20px; font-size:20px; text-align:center;}
    .on {background:#00aa00; color:white;}
    .off {background:#cc0000; color:white;}
    .auto {background:#0066cc; color:white;}
    .info {margin:20px; font-size:18px; text-align:center;}
  </style>
</head>
<body>
  <h1>HỆ THỐNG ĐIỀU KHIỂN BỂ CÁ NAGUMO</h1>
  <p style="text-align:center;">Trường Đại học Hàng Hải Việt Nam - VIMARU 2025</p>

  <div class="status" id="connectStatus">Đang kết nối...</div>

  <div class="info">
    Nhiệt độ: <b><span id="temp">--</span> °C</b><br><br>
    Mực nước: <b><span id="dist">--</span> mm</b>
  </div>

  <button class="btn auto" id="btnAuto">CHẾ ĐỘ AUTO</button>
  <button class="btn off" id="btnPump">BƠM: DỪNG</button>
  <button class="btn off" id="btnLight">ĐÈN: TẮT</button>

  <div class="info">
    Số lần bật bơm: <b><span id="pumpCount">0</span></b><br>
    Số lần bật đèn: <b><span id="lightCount">0</span></b>
  </div>

  <div style="text-align:center; margin-top:30px;">
    <a href="report.html" style="font-size:18px; color:#0066cc;">→ Xem báo cáo chi tiết</a>
  </div>

<script>
const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
const topic = 'vimaru/nagumo/status';

client.on('connect', () => {
  document.getElementById('connectStatus').innerHTML = '<b style="color:green;">ĐÃ KẾT NỐI THÀNH CÔNG!</b>';
  client.subscribe(topic);
});

let latest = {};
client.on('message', (t, msg) => {
  latest = JSON.parse(msg);
  document.getElementById('temp').innerText = latest.temp?.toFixed(1) || '--';
  document.getElementById('dist').innerText = latest.dist || '--';
  document.getElementById('pumpCount').innerText = latest.pumpCount || 0;
  document.getElementById('lightCount').innerText = latest.lightCount || 0;

  document.getElementById('btnAuto').className = latest.auto ? 'btn auto' : 'btn off';
  document.getElementById('btnAuto').innerText = latest.auto ? 'CHẾ ĐỘ AUTO' : 'CHẾ ĐỘ THỦ CÔNG';

  document.getElementById('btnPump').className = latest.pump ? 'btn on' : 'btn off';
  document.getElementById('btnPump').innerText = latest.pump ? 'BƠM ĐANG CHẠY' : 'BƠM DỪNG';

  document.getElementById('btnLight').className = latest.light ? 'btn on' : 'btn off';
  document.getElementById('btnLight').innerText = latest.light ? 'ĐÈN ĐANG BẬT' : 'ĐÈN TẮT';
});

function send(obj) { client.publish('vimaru/nagumo/cmd', JSON.stringify(obj)); }
document.getElementById('btnAuto').onclick  = () => send({auto: !latest.auto});
document.getElementById('btnPump').onclick  = () => send({pump: !latest.pump});
document.getElementById('btnLight').onclick = () => send({light: !latest.light});
</script>
</body>
</html>