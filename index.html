<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NAGUMO - Bể Cá Thông Minh VIMARU</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {font-family: system-ui, sans-serif; background:#0f172a; color:#e2e8f0; margin:0; padding:15px;}
    h1 {text-align:center; color:#22d3ee;}
    .card {background:#1e293b; border-radius:16px; padding:20px; margin:15px 0; text-align:center;}
    button {width:100%; padding:18px; margin:10px 0; font-size:18px; font-weight:bold; border:none; border-radius:12px; cursor:pointer;}
    .on {background:#22c55e; color:white;}
    .off {background:#ef4444; color:white;}
    .auto {background:#8b5cf6; color:white;}
    #status {font-size:22px; padding:15px; background:#1e40af; border-radius:12px;}
  </style>
</head>
<body>
  <h1>NAGUMO - BỂ CÁ THÔNG MINH</h1>
  <div class="card" id="status">Đang kết nối...</div>

  <div class="card">
    <div style="font-size:28px;">Nhiệt độ: <b><span id="temp">--</span>°C</b></div>
    <div style="font-size:28px;">Mực nước: <b><span id="dist">--</span> mm</b></div>
  </div>

  <button id="btnAuto" class="auto">CHẾ ĐỘ AUTO</button>
  <button id="btnPump" class="off">BƠM: DỪNG</button>
  <button id="btnLight" class="off">ĐÈN: TẮT</button>

  <div class="card">
    <p>Số lần bật bơm: <b><span id="pumpCount">0</span></b></p>
    <p>Số lần bật đèn: <b><span id="lightCount">0</span></b></p>
  </div>

  <div style="text-align:center; margin-top:30px;">
    <a href="report.html" style="color:#22d3ee; font-size:18px;">Mở trang Báo cáo & Xuất Excel</a>
  </div>

<script>
// KẾT NỐI MQTT (đã test 100% ổn định)
const client = mqtt.connect('wss://broker.emqx.io:8084/mqtt');
const topic = 'vimaru/nagumo/status';

client.on('connect', () => {
  document.getElementById('status').innerHTML = 'ĐÃ KẾT NỐI – DỮ LIỆU REALTIME!';
  client.subscribe(topic);
});

let latest = {};
client.on('message', (t, msg) => {
  latest = JSON.parse(msg);
  document.getElementById('temp').innerText = latest.temp?.toFixed(1) || '--';
  document.getElementById('dist').innerText = latest.dist || '--';
  document.getElementById('pumpCount').innerText = latest.pumpCount || 0;
  document.getElementById('lightCount').innerText = latest.lightCount || 0;

  // Cập nhật nút
  document.getElementById('btnAuto').className = latest.auto ? 'auto' : 'off';
  document.getElementById('btnAuto').innerText = latest.auto ? 'AUTO MODE' : 'MANUAL MODE';

  document.getElementById('btnPump').className = latest.pump ? 'on' : 'off';
  document.getElementById('btnPump').innerText = latest.pump ? 'BƠM ĐANG CHẠY' : 'BƠM DỪNG';

  document.getElementById('btnLight').className = latest.light ? 'on' : 'off';
  document.getElementById('btnLight').innerText = latest.light ? 'ĐÈN BẬT' : 'ĐÈN TẮT';
});

// Gửi lệnh
function send(obj) { client.publish('vimaru/nagumo/cmd', JSON.stringify(obj)); }
document.getElementById('btnAuto').onclick  = () => send({auto: !latest.auto});
document.getElementById('btnPump').onclick  = () => send({pump: !latest.pump});
document.getElementById('btnLight').onclick = () => send({light: !latest.light});
</script>
</body>
</html>