<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NAGUMO • Báo cáo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --accent: #00d4ff; }
    body {font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); padding:20px; margin:0;}
    h1 {text-align:center; color:var(--accent); font-size:32px; margin-bottom:8px;}
    h2 {text-align:center; color:#94a3b8; font-size:16px; margin-bottom:30px;}
    .controls {text-align:center; margin:30px 0;}
    input, button {padding:12px 20px; font-size:16px; border-radius:12px; border:none;}
    button {background:var(--accent); color:black; font-weight:600; cursor:pointer;}
    .summary {display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin:40px 0;}
    .sum-card {background:var(--card); border-radius:16px; padding:24px; text-align:center;}
    .sum-value {font-size:36px; font-weight:700;}
    .sum-label {font-size:14px; color:#94a3b8; margin-top:8px;}
    table {width:100%; border-collapse:collapse; margin-top:30px; background:var(--card); border-radius:16px; overflow:hidden;}
    th {background:#1e40af; padding:16px; text-align:center; font-weight:600; color:white;}
    td {padding:14px; text-align:center; border-bottom:1px solid #334155;}
    .fish-yes {color:#10b981; font-weight:bold;}
    .fish-no {color:#ef4444; font-weight:bold;}
  </style>
</head>
<body>
  <h1>NAGUMO</h1>
  <h2>Báo cáo chi tiết • Cảm biến DS18B20 & Siêu âm</h2>

  <div class="controls">
    <input type="date" id="datePicker"/>
    <button onclick="loadReport()">TẢI BÁO CÁO</button>
  </div>

  <div class="summary">
    <div class="sum-card">
      <div class="sum-value" id="lightCnt">0</div>
      <div class="sum-label">Lần bật đèn</div>
    </div>
    <div class="sum-card">
      <div class="sum-value" id="pumpCnt">0</div>
      <div class="sum-label">Lần bật bơm</div>
    </div>
    <div class="sum-card">
      <div class="sum-value" id="avgTemp">--</div>
      <div class="sum-label">Nhiệt độ trung bình</div>
    </div>
    <div class="sum-card">
      <div class="sum-value" id="fishStatus">?</div>
      <div class="sum-label">Trạng thái cá cuối ngày</div>
    </div>
  </div>

  <table id="table">
    <tr>
      <th>STT</th>
      <th>Thời gian</th>
      <th>Hành động</th>
      <th>Nhiệt độ (°C)</th>
      <th>Mực nước (mm)</th>
      <th>Phát hiện cá</th>
    </tr>
  </table>

<script>
// Cấu hình Firebase của bạn
const firebaseConfig = {
  apiKey: "AIzaSyAtxDRC6LzxTD-d0JvRDPQnejNgYFVzQ38",
  databaseURL: "https://nagumo-2f89d-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Mặc định chọn hôm nay
document.getElementById('datePicker').valueAsDate = new Date();

function loadReport() {
  const date = document.getElementById('datePicker').value;
  const start = new Date(date).setHours(0, 0, 0, 0);
  const end = new Date(date).setHours(23, 59, 59, 999);

  // Reset bảng
  document.getElementById('table').innerHTML = `<tr>
    <th>STT</th><th>Thời gian</th><th>Hành động</th>
    <th>Nhiệt độ (°C)</th><th>Mực nước (mm)</th><th>Phát hiện cá</th>
  </tr>`;

  let stt = 1;
  let lightCnt = 0, pumpCnt = 0;
  let sumTemp = 0, tempCount = 0;
  let lastFishStatus = "Chưa có dữ liệu";

  db.ref("/history").once("value").then(snap => {
    const records = snap.val();
    if (!records) return;

    Object.keys(records).forEach(key => {
      const h = records[key];

      // Kiểm tra timestamp có hợp lệ và trong ngày không
      if (!h.timestamp) return;
      const ts = new Date(h.timestamp).getTime();
      if (ts < start || ts > end) return;

      // Đếm hành động
      if (h.action && h.action.includes("Light ON")) lightCnt++;
      if (h.action && h.action.includes("Pump ON")) pumpCnt++;

      // Tính nhiệt độ trung bình
      if (h.temp !== undefined) {
        sumTemp += parseFloat(h.temp);
        tempCount++;
      }

      // Cập nhật trạng thái cá mới nhất
      if (h.fishDetected !== undefined) {
        lastFishStatus = h.fishDetected ? "PHÁT HIỆN CÁ" : "KHÔNG THẤY CÁ";
      }

      // Thêm dòng vào bảng
      const row = document.getElementById('table').insertRow();
      row.insertCell().innerText = stt++;
      row.insertCell().innerText = new Date(h.timestamp).toLocaleString('vi-VN');
      row.insertCell().innerText = h.action || "—";
      row.insertCell().innerText = h.temp !== undefined ? parseFloat(h.temp).toFixed(1) + "°C" : "—";
      row.insertCell().innerText = h.dist !== undefined ? h.dist + " mm" : "—";

      const fishCell = row.insertCell();
      if (h.fishDetected !== undefined) {
        fishCell.innerHTML = h.fishDetected
          ? '<span class="fish-yes">CÓ CÁ</span>'
          : '<span class="fish-no">KHÔNG</span>';
      } else {
        fishCell.innerText = "—";
      }
    });

    // Cập nhật tổng kết
    document.getElementById('lightCnt').innerText = lightCnt;
    document.getElementById('pumpCnt').innerText = pumpCnt;
    document.getElementById('avgTemp').innerText = tempCount > 0 ? (sumTemp / tempCount).toFixed(1) + "°C" : "—";
    document.getElementById('fishStatus').innerText = lastFishStatus;
  });
}

// Tự động load khi mở trang
loadReport();
</script>
</body>
</html>