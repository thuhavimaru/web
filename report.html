<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>NAGUMO - Báo cáo cơ bản</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {font-family: Arial, sans-serif; background:white; color:black; padding:20px; margin:0;}
    h1, h2 {text-align:center; color:#0066cc;}
    table {width:100%; border-collapse:collapse; margin:20px 0; font-size:14px;}
    th, td {border:1px solid #000; padding:8px; text-align:center;}
    th {background:#f0f0f0;}
    .header {background:#0066cc; color:white; padding:15px; text-align:center; font-size:20px;}
    .info {margin:15px 0; font-size:16px;}
    .highlight {font-weight:bold; color:#d00;}
  </style>
</head>
<body>

<div class="header">
  <h1>HỆ THỐNG GIÁM SÁT BỂ CÁ NAGUMO</h1>
  <h2>TRƯỜNG ĐẠI HỌC HÀNG HẢI VIỆT NAM - VIMARU</h2>
</div>

<div class="info">
  <label>Chọn ngày báo cáo: </label>
  <input type="date" id="datePicker"/>
  <button onclick="loadReport()">XEM BÁO CÁO</button>
</div>

<div class="info">
  <h2 id="title">BÁO CÁO NGÀY: .........</h2>
  <p>Tổng số lần bật đèn: <b id="lightCnt">0</b> lần</p>
  <p>Tổng số lần bật bơm: <b id="pumpCnt">0</b> lần</p>
  <p>Nhiệt độ trung bình: <b id="avgTemp">--</b> °C</p>
  <p>Trạng thái cá cuối ngày: <b id="fishStatus">Chưa có dữ liệu</b></p>
</div>

<table id="table">
  <tr>
    <th>STT</th>
    <th>Thời gian</th>
    <th>Nguồn</th>
    <th>Hành động</th>
    <th>Nhiệt độ DS18B20 (°C)</th>
    <th>Mực nước (mm)</th>
    <th>Phát hiện cá</th>
  </tr>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAtxDRC6LzxTD-d0JvRDPQnejNgYFVzQ38",
  databaseURL: "https://nagumo-2f89d-default-rtdb.asia-southeast1.firebasedatabase.app",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

document.getElementById('datePicker').valueAsDate = new Date();

function loadReport() {
  const date = document.getElementById('datePicker').value;
  const start = new Date(date).setHours(0,0,0,0);
  const end = new Date(date).setHours(23,59,59,999);

  document.getElementById('title').innerText = `BÁO CÁO NGÀY: ${date}`;
  document.getElementById('table').innerHTML = `<tr>
    <th>STT</th><th>Thời gian</th><th>Nguồn</th><th>Hành động</th>
    <th>Nhiệt độ DS18B20 (°C)</th><th>Mực nước (mm)</th><th>Phát hiện cá</th>
  </tr>`;

  let stt = 1, lightCnt = 0, pumpCnt = 0, sumTemp = 0, tempCount = 0;
  let lastFish = "Không thấy cá";

  db.ref("/history").once("value").then(snap => {
    const data = snap.val() || {};
    for (let key in data) {
      const h = data[key];
      if (h.timestamp) {
        const ts = new Date(h.timestamp).getTime();
        if (ts >= start && ts <= end) {
          if (h.action?.includes("Light ON")) lightCnt++;
          if (h.action?.includes("Pump ON")) pumpCnt++;

          if (h.temp !== undefined) {
            sumTemp += parseFloat(h.temp);
            tempCount++;
          }
          if (h.fishDetected !== undefined) {
            lastFish = h.fishDetected ? "PHÁT HIỆN CÁ" : "KHÔNG THẤY CÁ";
          }

          const row = document.getElementById('table').insertRow();
          row.insertCell().innerText = stt++;
          row.insertCell().innerText = new Date(h.timestamp).toLocaleString('vi-VN');
          row.insertCell().innerText = h.by || "ESP";
          row.insertCell().innerText = h.action || "-";
          row.insertCell().innerText = h.temp !== undefined ? parseFloat(h.temp).toFixed(1) : "--";
          row.insertCell().innerText = h.dist !== undefined ? h.dist : "--";
          const fishCell = row.insertCell();
          fishCell.innerText = h.fishDetected !== undefined 
            ? (h.fishDetected ? "CÓ" : "KHÔNG") 
            : "--";
          if (h.fishDetected) fishCell.style.color = "green";
        }
      }
    }
    document.getElementById('lightCnt').innerText = lightCnt;
    document.getElementById('pumpCnt').innerText = pumpCnt;
    document.getElementById('avgTemp').innerText = tempCount > 0 ? (sumTemp/tempCount).toFixed(2) : "--";
    document.getElementById('fishStatus').innerText = lastFish;
  });
}

loadReport();
</script>
</body>
</html>